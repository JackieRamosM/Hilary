var _ = require('underscore');

var ActivityAPI = require('oae-activity');
var ActivityConstants = require('oae-activity/lib/constants').ActivityConstants;
var ActivityModel = require('oae-activity/lib/model');
var ActivityUtil = require('oae-activity/lib/util');

var AuthzConstants = require('oae-authz/lib/constants').AuthzConstants;
var AuthzUtil = require('oae-authz/lib/util');

var MeetingAPI = require('./api');
var MeetingConstants = require('./constants').MeetingConstants;
var MeetingDAO = require('./internal/dao');

var TenantsUtil = require('oae-tenants/lib/util');

ActivityAPI.registerActivityType(MeetingConstants.activity.ACTIVITY_MEETING_CREATE, {
    'groupBy': [{'actor': true}],
    'streams': {
        'activity': {
            'router': {
                'actor': ['self', 'followers'],
                'object': ['self', 'members']
            }
        },
        'notification': {
            'router': {
                'object': ['members']
            }
        }
    
/*'activity': {
          'router': {
              'actor': ['self', 'followers'],
              'object': ['self', 'members', 'followers'],
              'target': ['self', 'members']
          }
      },
      'notification': {
          'router': {
              'object': ['self'],
              'target': ['managers']
          },
         'email': {
                'email': true,
                'emailTemplateModule': 'oae-principals',
                'emailTemplateId': 'notify-group-add-member'
          }
      }*/
	}
});
MeetingAPI.on(MeetingConstants.events.CREATED_MEETING, function(ctx, meeting, members) {
	console.log("en activity.js");
	//console.log(meeting.id);
	//console.log("m4",members);
    var millis = Date.now();
    var actorResource = new ActivityModel.ActivitySeedResource('user', ctx.user().id, {'user': ctx.user()});
	//console.log(actorResource);
    var objectResource = new ActivityModel.ActivitySeedResource('meeting', meeting.id, {'meeting': meeting});
    //console.log(objectResource);
	var activitySeed = new ActivityModel.ActivitySeed(MeetingConstants.activity.ACTIVITY_MEETING_CREATE, millis, ActivityConstants.verbs.CREATE, actorResource, objectResource);
    //console.log("seed",activitySeed, activitySeed.objectResource);
	ActivityAPI.postActivity(ctx, activitySeed);
	
});
var meetingProducer = function(resource, callback) {
	console.log("En meetingproducer");
	console.log("el meeting llega asi",resource.resourceData.meeting);
    /*MeetingDAO.getMeetingWithID(resource.resourceId, function(err, meeting) {
        if (err) {
            return callback(err);
        }
		console.log("el meeting es ",meeting);*/
    return callback(null, createPersistentMeetingActivityEntity(resource.resourceData.meeting));
    //});
};
var createPersistentMeetingActivityEntity = function(meeting) {
	console.log("en createPersistentMeetingActivityEntity");
	var persistentEntity = {'objectType': 'meeting', 'meeting': meeting};
    persistentEntity[ActivityConstants.properties.OAE_ID] = meeting.id;
	//console.log("persistentEntity", persistentEntity);
    return persistentEntity;
};
var meetingTransformer = function(ctx, activityEntities, callback) {
	console.log("en meetingTransformer");
    var transformedActivityEntities = {};
	console.log("activityEntities", activityEntities);
    var allRevisionIds = [];
    _.each(activityEntities, function(entities, activityId) {
	console.log("entities",entities);
        transformedActivityEntities[activityId] = transformedActivityEntities[activityId] || {};
        _.each(entities, function(entity, entityId) {
            // Transform the persistent entity into an ActivityStrea.ms compliant format
            console.log("entity1", entity, entityId);
			transformedActivityEntities[activityId][entityId] = transformPersistentMeetingActivityEntity(ctx, entity);
        	//console.log(transformedActivityEntities[activityId][entityId]);
		});
    });
    return callback(null, transformedActivityEntities);
};
var transformPersistentMeetingActivityEntity = function(ctx, entity) {
	//console.log("meeting ************************************************");
	console.log("\n\n\n en transformPersistentMeetingActivityEntity")
    var meeting = entity.meeting;
	//console.log("meeting", meeting);
	//console.log("entity2", meeting.id);
	var id = meeting.id;
	var displayName = meeting.displayName;	
	var visibility = meeting.visibility;
	//console.log("id", id,displayName,visibility);
    
	// Generate URLs for this activity
    var tenant = ctx.tenant();
    var baseUrl = TenantsUtil.getBaseUrl(tenant);
    var globalId = baseUrl + '/api/meeting/' + id;
    var resource = AuthzUtil.getResourceFromId(id);
	//console.log("resource=",resource);
    var profileUrl = baseUrl + '/meeting/' + resource.tenantAlias + '/' + resource.resourceId;

    var opts = {};
    opts.url = profileUrl;
	
    opts.displayName =  displayName;
    opts.ext = {};
	
    opts.ext[ActivityConstants.properties.OAE_ID] =  id;
    opts.ext[ActivityConstants.properties.OAE_VISIBILITY] =  visibility;
    //opts.ext[ActivityConstants.properties.OAE_PROFILEPATH] = meeting.profilePath;
	//console.log(meeting.profilePath);
    return new ActivityModel.ActivityEntity('meeting', globalId, opts);
};
var meetingInternalTransformer = function(ctx, activityEntities, callback) {
	console.log("en meetingInternetTransformer");
    var transformedActivityEntities = {};

    var allRevisionIds = [];
    _.each(activityEntities, function(entities, activityId) {
        transformedActivityEntities[activityId] = transformedActivityEntities[activityId] || {};
        _.each(entities, function(entity, entityId) {
            // Transform the persistent entity into the OAE model
            transformedActivityEntities[activityId][entityId] = entity.meeting;
        });
    });
    return callback(null, transformedActivityEntities);
};
ActivityAPI.registerActivityEntityType('meeting', {
    'producer': meetingProducer,
    'transformer': {
        'activitystreams': meetingTransformer,
        'internal': meetingInternalTransformer
    },
    'propagation': function(associationsCtx, entity, callback) {
	console.log("en propagation");
	//console.log("p6",entity.meeting.visibility);
	//console.log("p7", AuthzConstants.joinable.NO);
        ActivityUtil.getStandardResourcePropagation(entity.meeting.visibility, AuthzConstants.joinable.NO, callback);
    }
});

ActivityAPI.registerActivityEntityAssociation('meeting', 'self', function(associationsCtx, entity, callback) {
    return callback(null, [entity[ActivityConstants.properties.OAE_ID]]);
});

ActivityAPI.registerActivityEntityAssociation('meeting', 'members-by-role', function(associationsCtx, entity, callback) {
    ActivityUtil.getAllAuthzMembersByRole(entity[ActivityConstants.properties.OAE_ID], callback);
});

ActivityAPI.registerActivityEntityAssociation('meeting', 'members', function(associationsCtx, entity, callback) {
    associationsCtx.get('members-by-role', function(err, membersByRole) {
        if (err) {
            return callback(err);
        }

        return callback(null, _.flatten(_.values(membersByRole)));
    });
});