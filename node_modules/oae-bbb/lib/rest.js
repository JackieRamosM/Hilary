var _ = require('underscore');
var OAE = require('oae-util/lib/oae');
var MeetingAPI = require('./api.meeting');
var MeetingConstants = require('oae-bbb/lib/constants').MeetingConstants;


OAE.tenantRouter.on('post', '/api/meeting/create', function(req, res) {
	var members = {};
	if (_.isArray(req.body.managers)) {
        	_.each(req.body.managers, function(manager) {
           	members[manager] = MeetingConstants.roles.MANAGER;
		console.log("managers array", members[manager]);
        });
    	} else if (_.isString(req.body.managers)) {
        	members[req.body.managers] = MeetingConstants.roles.MANAGER;
		console.log("managers String", members[req.body.managers]);
    	}

    	if (_.isArray(req.body.members)) {
        	_.each(req.body.members, function(member) {
            	members[member] = MeetingConstants.roles.MEMBER;
		console.log("members array", members[member]);
        });
    	} else if (_.isString(req.body.members)) {
        	members[req.body.members] = MeetingConstants.roles.MEMBER;
		console.log("members string", members[req.body.members]);
    	}
    	
	
	MeetingAPI.createMeeting(req.ctx, req.body.displayName, req.body.description,req.body.welcomemessage, members, null, req.body.record, req.body.duration, function(err, meeting) {
     	if (err) {
			return res.send(err.code, err.msg);
        	}
		res.send(200,meeting);
    	});
	
});


OAE.tenantRouter.on('post', '/api/meeting', function(req, res) {
	
	MeetingAPI.getMeetings(req.body.userID, function(err,data){
			
		if(err){
			return res.send(err.code, err.msg);
		}
		
		return res.send(200,data);
	});

});


OAE.tenantRouter.on('post', '/api/create', function(req, res) {
	
	MeetingAPI.createBBBCall(req.body.meetingID, req.body.name, req.body.duration, req.body.record, req.body.welcomeMessage, req.body.meetingname, function(err,data){
		if(err){
			return res.send(404, "fail");
		}
		return res.send(200,data);
	});

});