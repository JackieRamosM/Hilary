var sha1 = require('sha1');
var http = require('http');
var xml2js = require('xml2js');
var MeetingDAO = require ('./dao.js');

var server = "http://192.168.1.104/";
var secret= "66b7d7fb3d639fd6d0f7cfbe216b8727";


var createBBBCall = exports.createBBBCall = function (meetingID, name, callback){
		
	
	var attendeePW = meetingID.substr(meetingID.length - 4);
	var params = "meetingID=" + meetingID + "&attendeePW=" + attendeePW;
	var checksum = sha1("create"+ params +secret);
	var url = server + "bigbluebutton/api/create?" + params + "&checksum=" + checksum;
	var parser = new xml2js.Parser();
	http.request(url, function(res) {
  		res.setEncoding('utf8');
 	 	res.on('data', function (chunk) {
			parser.parseString(chunk, function(err, result){
				if(result['response']['returncode'] == "SUCCESS"){
									
					MeetingDAO.getPass(meetingID, function(err, password){
						if(err){
							pass= "";
							return callback(err);
						}
						else{
							pass = password[0][0]["value"];
							params = "meetingID=" + meetingID + "&password=" + pass + "&fullName=" + name;
							checksum = sha1("join"+ params +secret);
							url = server + "bigbluebutton/api/join?" + params + "&checksum=" + checksum;
							return callback(null, url);	
						}		
		
					});	
		
				}
				else {
					if(result['response']['messageKey'] == "idNotUnique"){
						
						MeetingDAO.getPass(meetingID, function(err, password){
							if(err){
								pass= "";
								return callback(err);
							}
							else{
								pass = password[0][0]["value"];
								params = "meetingID=" + meetingID + "&password=" + pass + "&fullName=" + name;
								checksum = sha1("join"+ params +secret);
								url = server + "bigbluebutton/api/join?" + params + "&checksum=" + checksum;
								return callback(null, url);	
							}		
		
						});	
					}
					else{
						return callback(err);						
					}
				}				
			});
		});
	}).end();
};